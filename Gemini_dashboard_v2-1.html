<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yahoo ç‰ˆä½æˆæ•ˆæ±ºç­–å„€è¡¨æ¿ v3.3 (Strategic AI)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; color: #f8fafc; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    
    /* åˆ†ç´šè‰²å½©æ¨£å¼ */
    .grade-a { background-color: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
    .grade-b { background-color: rgba(234, 179, 8, 0.15); color: #facc15; border: 1px solid rgba(234, 179, 8, 0.3); }
    .grade-c { background-color: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
    .grade-d { background-color: rgba(148, 163, 184, 0.1); color: #94a3b8; border: 1px solid rgba(148, 163, 184, 0.2); }
    
    .ai-loading { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    
    /* AI å ±å‘Š Markdown æ¸²æŸ“æ¨¡æ“¬ */
    #ai-output-content h2 { color: #38bdf8; font-size: 1.25rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.5rem; border-left: 4px solid #38bdf8; padding-left: 10px; }
    #ai-output-content h3 { color: #facc15; font-size: 1.1rem; font-weight: 700; margin-top: 1.2rem; margin-bottom: 0.5rem; }
    #ai-output-content p { margin-bottom: 1rem; line-height: 1.7; }
    #ai-output-content ul { list-style: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
    #ai-output-content li { margin-bottom: 0.5rem; }
    #ai-output-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.85rem; background: rgba(30, 41, 59, 0.5); border-radius: 8px; overflow: hidden; }
    #ai-output-content th { background: #334155; padding: 10px; text-align: left; color: #94a3b8; }
    #ai-output-content td { border-bottom: 1px solid #334155; padding: 10px; color: #cbd5e1; }
    #ai-output-content strong { color: #f8fafc; font-weight: 700; }
  </style>
</head>
<body class="flex h-screen overflow-hidden">

  <!-- Sidebar: Configuration -->
  <aside class="w-80 bg-slate-900 border-r border-slate-800 p-6 flex flex-col gap-6 shrink-0 overflow-y-auto custom-scrollbar">
    <div>
      <h2 class="text-sky-400 text-xl font-bold mb-1">æ±ºç­–åƒæ•¸è¨­å®š</h2>
      <p class="text-slate-500 text-[10px]">å®šç¾© A/B/C åˆ†ç´šæ¨™æº–</p>
    </div>

    <div class="space-y-4">
      <div class="space-y-1">
        <label class="block text-xs font-medium text-slate-400">A ç´šé–€æª» (CTR %)</label>
        <input type="number" id="threshold-a" value="0.5" step="0.1" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:ring-2 focus:ring-sky-500 outline-none">
      </div>
      <div class="space-y-1">
        <label class="block text-xs font-medium text-slate-400">B ç´šé–€æª» (CTR %)</label>
        <input type="number" id="threshold-b" value="0.1" step="0.1" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:ring-2 focus:ring-yellow-500 outline-none">
      </div>
      <div class="space-y-1">
        <label class="block text-xs font-medium text-slate-400">C ç´šæ›å…‰åŸºæº– (Imps >)</label>
        <input type="number" id="threshold-imps" value="1000" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:ring-2 focus:ring-red-500 outline-none">
      </div>
    </div>

    <div class="space-y-3 pt-4 border-t border-slate-800">
      <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">AI å¹•åƒšæ•™ç·´</h3>
      <button onclick="generateStrategicAnalysis()" class="w-full flex items-center justify-center gap-2 bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 border border-purple-500/30 font-bold py-2.5 px-4 rounded-xl cursor-pointer transition-all text-sm shadow-lg shadow-purple-900/10">
        âœ¨ æ·±åº¦å°æ¨™èˆ‡ç­–ç•¥ç”¢å‡º
      </button>
      <button onclick="generateVoiceBriefing()" id="btn-voice" class="w-full flex items-center justify-center gap-2 bg-amber-600/20 hover:bg-amber-600/30 text-amber-400 border border-amber-500/30 font-bold py-2.5 px-4 rounded-xl cursor-pointer transition-all text-sm">
        âœ¨ è½å–ç­–ç•¥æ‘˜è¦
      </button>
    </div>

    <div class="mt-auto space-y-4 pt-6 border-t border-slate-800">
      <div class="space-y-2">
        <p class="text-[10px] text-slate-500 font-bold uppercase">1. å“ç‰Œç›®æ¨™ (PDF)</p>
        <label for="pdf-upload" class="flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold py-2.5 px-4 rounded-xl cursor-pointer border border-slate-700 transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
          ä¸Šå‚³å“ç‰Œæˆ°ç•¥ PDF
        </label>
        <input type="file" id="pdf-upload" class="hidden" accept=".pdf">
        <div id="pdf-status" class="text-[9px] text-slate-600 text-center italic">å°šæœªå°æ¨™æˆ°ç•¥æ–‡æª”</div>
      </div>
      <div class="space-y-2">
        <p class="text-[10px] text-slate-500 font-bold uppercase">2. æŠ•æ”¾æ•¸æ“š (CSV)</p>
        <label for="file-upload" class="flex items-center justify-center gap-2 bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-4 rounded-xl cursor-pointer shadow-lg text-sm transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
          ä¸Šå‚³ Yahoo å ±è¡¨
        </label>
        <input type="file" id="file-upload" class="hidden" accept=".csv">
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col overflow-hidden bg-slate-950">
    <!-- Header -->
    <header class="h-16 border-b border-slate-800 flex items-center justify-between px-10 shrink-0 bg-slate-900/50 backdrop-blur">
      <div class="flex items-center gap-3">
        <div class="h-3 w-3 bg-sky-500 rounded-full shadow-[0_0_10px_#38bdf8]"></div>
        <h1 class="text-lg font-bold tracking-tight">Yahoo æˆ°ç•¥æ±ºç­–ä¸­å¿ƒ <span class="text-slate-500 font-normal ml-2 text-xs">v3.3 AI Strategist</span></h1>
      </div>
      <div id="file-indicator" class="text-xs text-slate-500 bg-slate-800/50 px-3 py-1 rounded-full">ç­‰å¾…è³‡æ–™åŒ¯å…¥...</div>
    </header>

    <div class="flex-1 overflow-y-auto px-10 pb-10 custom-scrollbar">
      <!-- Welcome/SOP -->
      <div id="welcome-screen" class="flex flex-col items-center justify-center min-h-[400px] text-slate-500 border-2 border-dashed border-slate-800 rounded-[2.5rem] mt-10 p-12 text-center">
        <div class="bg-slate-900 p-6 rounded-full mb-6">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-slate-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
        </div>
        <h2 class="text-xl font-bold text-slate-300 mb-2">é–‹å§‹æ‚¨çš„ AI ç­–ç•¥åˆ†æ</h2>
        <p class="max-w-md text-sm leading-relaxed">
          1. é»æ“Šå·¦ä¸‹æ–¹ä¸Šå‚³ <b>å“ç‰Œç›®æ¨™ PDF</b> (ç†è§£å“ç‰Œé¡˜æ™¯)<br>
          2. åŒ¯å…¥ <b>Yahoo CSV æŠ•æ”¾æ•¸æ“š</b> (æˆæ•ˆäº‹å¯¦)<br>
          3. å•Ÿå‹• <b>AI æ·±åº¦å°æ¨™</b> ç”¢å‡ºé›™é‡å„ªåŒ–ç­–ç•¥
        </p>
      </div>

      <div id="analysis-content" class="hidden space-y-8 mt-8">
        <!-- Summary Dashboard -->
        <div class="grid grid-cols-4 gap-6">
          <div class="bg-slate-900/50 p-6 rounded-3xl border border-slate-800 hover:border-slate-700 transition-colors">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">ç¸½æ›å…‰é‡ (Imps)</p>
            <h3 id="stat-imps" class="text-3xl font-bold text-white tracking-tighter">-</h3>
          </div>
          <div class="bg-slate-900/50 p-6 rounded-3xl border border-slate-800 hover:border-slate-700 transition-colors">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">ç¸½é»æ“Šæ•¸ (Clicks)</p>
            <h3 id="stat-clicks" class="text-3xl font-bold text-white tracking-tighter">-</h3>
          </div>
          <div class="bg-slate-900/50 p-6 rounded-3xl border border-slate-800 hover:border-slate-700 transition-colors">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">åŠ æ¬Š CTR (%)</p>
            <h3 id="stat-ctr" class="text-3xl font-bold text-sky-400 tracking-tighter">-%</h3>
          </div>
          <div class="bg-slate-900/50 p-6 rounded-3xl border border-slate-800 hover:border-slate-700 transition-colors">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">A ç´šç‰ˆä½ (High Value)</p>
            <h3 id="stat-grade-a" class="text-3xl font-bold text-green-400 tracking-tighter">-</h3>
          </div>
        </div>

        <!-- AI Output Box -->
        <div id="ai-output-box" class="hidden bg-slate-900/90 border border-purple-500/30 rounded-[2rem] p-8 relative shadow-2xl backdrop-blur-xl">
          <div class="flex items-center justify-between mb-8 pb-4 border-b border-slate-800">
            <div class="flex items-center gap-3">
              <div class="w-2 h-2 bg-purple-500 rounded-full animate-ping"></div>
              <h4 id="ai-output-title" class="text-purple-400 font-bold tracking-tight">AI æˆ°ç•¥æ·±åº¦å°æ¨™å ±å‘Š</h4>
            </div>
            <div class="flex gap-2">
               <button onclick="copyAIData()" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded-full text-slate-300">è¤‡è£½å ±å‘Š</button>
               <button onclick="closeAIOutput()" class="text-slate-500 hover:text-white ml-2">âœ•</button>
            </div>
          </div>
          <div id="ai-output-content" class="text-slate-300 text-sm leading-relaxed max-w-none">
            <!-- AI Content -->
          </div>
        </div>

        <!-- Data Table -->
        <div class="bg-slate-900/30 border border-slate-800 rounded-[2rem] overflow-hidden shadow-sm">
          <div class="px-8 py-5 border-b border-slate-800 flex justify-between items-center">
             <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest">ç‰ˆä½æ˜ç´°åˆ†æ</h4>
             <div class="text-[10px] text-slate-600 italic">* ä¾æ“šå³æ™‚åƒæ•¸é€²è¡Œåˆ†ç´š</div>
          </div>
          <table class="w-full text-left">
            <thead>
              <tr class="bg-slate-800/30 text-[10px] uppercase tracking-wider text-slate-500">
                <th class="px-8 py-4">åˆ†ç´š (Grade)</th>
                <th class="px-8 py-4">ç‰ˆä½åç¨± (Line Item)</th>
                <th class="px-8 py-4">æ›å…‰é‡</th>
                <th class="px-8 py-4">é»æ“Šæ•¸</th>
                <th class="px-8 py-4 text-right">CTR</th>
              </tr>
            </thead>
            <tbody id="data-tbody" class="divide-y divide-slate-800/50 text-xs text-slate-400">
              <!-- Rows Injected by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    const apiKey = ""; // API Key åŸ·è¡Œç’°å¢ƒæœƒè‡ªå‹•æä¾›
    let currentData = [];
    let pdfData = { base64: null, name: null };
    let summaryData = { aList: [], bList: [], cList: [], totalImps: 0, totalClicks: 0 };

    // DOM Elements
    const fileUpload = document.getElementById('file-upload');
    const pdfUpload = document.getElementById('pdf-upload');
    const pdfStatus = document.getElementById('pdf-status');
    const welcomeScreen = document.getElementById('welcome-screen');
    const analysisContent = document.getElementById('analysis-content');
    const tbody = document.getElementById('data-tbody');
    const aiOutputBox = document.getElementById('ai-output-box');
    const aiOutputContent = document.getElementById('ai-output-content');
    const fileIndicator = document.getElementById('file-indicator');

    // Threshold Inputs
    const inputA = document.getElementById('threshold-a');
    const inputB = document.getElementById('threshold-b');
    const inputImps = document.getElementById('threshold-imps');

    // Threshold Event Listeners
    [inputA, inputB, inputImps].forEach(el => {
      el.addEventListener('input', () => {
        if (currentData.length > 0) renderAnalysis(currentData);
      });
    });

    // File Handlers
    pdfUpload.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        pdfData.base64 = event.target.result.split(',')[1];
        pdfData.name = file.name;
        pdfStatus.innerText = `å°æ¨™æˆåŠŸï¼š${file.name}`;
        pdfStatus.className = "text-[9px] text-sky-400 text-center font-bold animate-pulse";
      };
      reader.readAsDataURL(file);
    });

    fileUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      fileIndicator.innerText = `å·²è¼‰å…¥ï¼š${file.name}`;
      const reader = new FileReader();
      reader.onload = (event) => {
        currentData = parseYahooCSV(event.target.result);
        welcomeScreen.classList.add('hidden');
        analysisContent.classList.remove('hidden');
        renderAnalysis(currentData);
      };
      reader.readAsText(file);
    });

    function parseYahooCSV(csv) {
      const lines = csv.split(/\r?\n/).filter(l => l.trim() !== "");
      if (lines.length < 2) return [];
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const idxItem = headers.indexOf('Line item');
      const idxImp = headers.indexOf('Total impressions');
      const idxClick = headers.indexOf('Total clicks');
      
      const map = new Map();
      for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
        if (row.length < headers.length) continue;
        const name = row[idxItem], imp = parseInt(row[idxImp]) || 0, click = parseInt(row[idxClick]) || 0;
        if (!map.has(name)) map.set(name, { name, imp: 0, click: 0 });
        const entry = map.get(name);
        entry.imp += imp; entry.click += click;
      }
      return Array.from(map.values());
    }

    function renderAnalysis(data) {
      const tA = parseFloat(inputA.value) / 100;
      const tB = parseFloat(inputB.value) / 100;
      const tImps = parseInt(inputImps.value);
      
      tbody.innerHTML = "";
      summaryData = { aList: [], bList: [], cList: [], totalImps: 0, totalClicks: 0 };
      
      const sorted = [...data].sort((a,b) => (b.click/b.imp) - (a.click/a.imp));

      sorted.forEach(item => {
        const ctr = item.imp > 0 ? (item.click / item.imp) : 0;
        let grade = "D", gradeText = "å™ªéŸ³", gradeClass = "grade-d";
        
        if (ctr >= tA) { 
          grade = "A"; gradeText = "é«˜åƒ¹å€¼"; gradeClass = "grade-a"; 
          summaryData.aList.push(item); 
        } else if (ctr >= tB) { 
          grade = "B"; gradeText = "æ½›åŠ›"; gradeClass = "grade-b"; 
          summaryData.bList.push(item); 
        } else if (item.imp >= tImps) { 
          grade = "C"; gradeText = "ä½æ•ˆ"; gradeClass = "grade-c"; 
          summaryData.cList.push(item); 
        }
        
        summaryData.totalImps += item.imp;
        summaryData.totalClicks += item.click;

        const tr = document.createElement('tr');
        tr.className = "hover:bg-slate-800/30 transition-colors";
        tr.innerHTML = `
          <td class="px-8 py-4"><span class="px-3 py-1 rounded-full font-bold text-[10px] ${gradeClass}">${grade} ç´šï½œ${gradeText}</span></td>
          <td class="px-8 py-4 font-medium text-slate-200">${item.name}</td>
          <td class="px-8 py-4">${item.imp.toLocaleString()}</td>
          <td class="px-8 py-4">${item.click.toLocaleString()}</td>
          <td class="px-8 py-4 text-right font-mono text-sky-400 font-bold">${(ctr*100).toFixed(3)}%</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('stat-imps').innerText = summaryData.totalImps.toLocaleString();
      document.getElementById('stat-clicks').innerText = summaryData.totalClicks.toLocaleString();
      const avgCtr = (summaryData.totalClicks / summaryData.totalImps * 100);
      document.getElementById('stat-ctr').innerText = isNaN(avgCtr) ? "0%" : avgCtr.toFixed(3) + "%";
      document.getElementById('stat-grade-a').innerText = summaryData.aList.length + " å€‹";
    }

    async function callGemini(prompt, sys, pdf64 = null) {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
      const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        systemInstruction: { parts: [{ text: sys }] }
      };
      if (pdf64) {
        payload.contents[0].parts.push({
          inlineData: { mimeType: "application/pdf", data: pdf64 }
        });
      }

      const retry = async (n) => {
        const resp = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        if (!resp.ok && n > 0) {
            await new Promise(r => setTimeout(r, Math.pow(2, 5-n) * 1000));
            return retry(n-1);
        }
        return await resp.json();
      };
      
      const res = await retry(5);
      return res.candidates[0].content.parts[0].text;
    }

    async function generateStrategicAnalysis() {
      if (currentData.length === 0) return alert("è«‹å…ˆä¸Šå‚³ Yahoo CSV å ±è¡¨");
      aiOutputBox.classList.remove('hidden');
      aiOutputContent.innerHTML = `<div class="ai-loading text-purple-400 p-8 flex items-center justify-center gap-4">
        <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        AI å¹•åƒšæ­£åœ¨æ·±åº¦ç ”è®€ PDF ä¸¦å°æ¨™æ•¸æ“šäº‹å¯¦ï¼Œç”¢å‡ºç¹é«”ä¸­æ–‡æ±ºç­–å ±å‘Š...
      </div>`;
      
      const prompt = `
      ## æ•¸æ“šèƒŒæ™¯äº‹å¯¦ (Yahoo Ads Data)
      - ç¸½æ›å…‰ï¼š${summaryData.totalImps}
      - ç¸½é»æ“Šï¼š${summaryData.totalClicks}
      - A ç´šç‰ˆä½ (ç¸¾æ•ˆé ‚å°–)ï¼š${summaryData.aList.map(i => i.name).join(', ')}
      - C ç´šç‰ˆä½ (è­¦ç¤ºå€)ï¼š${summaryData.cList.map(i => i.name).join(', ')}

      ## ä»»å‹™è¦æ±‚
      è«‹æ ¹æ“šé™„ä»¶å“ç‰Œæˆ°ç•¥ PDF (è‹¥ç„¡å‰‡ä¾æ“šé€šç”¨è¡ŒéŠ·é‚è¼¯)ï¼Œå°æ¯”ä¸Šè¿°å»£å‘Šæ•¸æ“šäº‹å¯¦ï¼Œç”¢å‡ºç¹é«”ä¸­æ–‡å ±å‘Šã€‚
      
      1. **æ•´é«”æ‘˜è¦ (Executive Summary)**ï¼šä»¥ã€Œæ•™ç·´å¹•åƒšã€å£å»æ‘˜è¦ç¾æ³èˆ‡å“ç‰Œç›®æ¨™çš„å¥‘åˆåº¦ã€‚
      2. **é›™ç­–ç•¥è·¯å¾‘ (Strategic Options)**ï¼š
         - **ç­–ç•¥ Aï¼š[æ•ˆèƒ½è½‰åŒ–å„ªå…ˆ]** (çŸ­æœŸå°æµã€CPC æ¥µå¤§åŒ–)ã€‚
         - **ç­–ç•¥ Bï¼š[å“ç‰Œæˆ°ç•¥é˜²ç¦¦]** (å´é‡å“ç‰Œå½¢è±¡ã€ç‰¹å®šé »é“ä½”ä½)ã€‚
      3. **æ“ä½œæŒ‡ç¤º (Actionable Directives)**ï¼šé‡å° A/B/C ä¸‰é¡ç‰ˆä½çµ¦å‡ºèˆ‡ç­–ç•¥å°æ‡‰çš„æ“ä½œæŒ‡ç¤ºã€‚
      
      è«‹ä½¿ç”¨ Markdown æ ¼å¼ä¸¦ç¢ºä¿å…§å®¹å…·å‚™å°ˆæ¥­æ·±åº¦ã€‚
      `;

      const sys = "ä½ æ˜¯ä¸€ä½é ‚å°–æ•¸ä½å»£å‘Šç­–ç•¥å¹•åƒšï¼Œæ“…é•·ä»¥çµ‚ç‚ºå§‹åœ°å°‡å“ç‰Œç›®æ¨™è½‰åŒ–ç‚ºæ“ä½œæŒ‡ä»¤ã€‚";
      
      try {
        const response = await callGemini(prompt, sys, pdfData.base64);
        aiOutputContent.innerHTML = formatMarkdown(response);
        aiOutputBox.scrollIntoView({ behavior: 'smooth' });
      } catch (e) {
        aiOutputContent.innerHTML = "<div class='text-red-400'>AI åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Keyã€‚</div>";
      }
    }

    function formatMarkdown(text) {
      return text
        .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mt-8 mb-4">$1</h2>')
        .replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold mt-6 mb-2">$1</h3>')
        .replace(/\*\*(.*)\*\*/gim, '<strong class="text-white font-bold">$1</strong>')
        .replace(/^\- (.*$)/gim, '<li class="ml-4 mb-2">$1</li>')
        .replace(/\|/g, '') // Remove table pipes for simple cleanup
        .replace(/\n/g, '<br>');
    }

    async function generateVoiceBriefing() {
      if (currentData.length === 0) return;
      const btn = document.getElementById('btn-voice');
      const originalText = btn.innerHTML;
      btn.innerText = "ğŸ”Š æ­£åœ¨ç”ŸæˆèªéŸ³æ‘˜è¦...";
      
      const briefing = `å¹•åƒšå ±å‘Šï¼šæœ¬æ¬¡ Yahoo å»£å‘ŠæŠ•æ”¾å…±å‰µé€  ${summaryData.totalImps} æ¬¡æ›å…‰ï¼ŒåŠ æ¬Šé»æ“Šç‡ç‚º ${(summaryData.totalClicks/summaryData.totalImps*100).toFixed(2)}%ã€‚æˆ‘å€‘è¾¨è­˜å‡º ${summaryData.aList.length} å€‹è¡¨ç¾å„ªç•°çš„ A ç´šç‰ˆä½ï¼Œå»ºè­°å„ªå…ˆåŠ ç¢¼ã€‚åŒæ™‚ AI å·²ç¶“æ ¹æ“šæ‚¨çš„å“ç‰Œç›®æ¨™ç”Ÿæˆå…©å¥—å„ªåŒ–ç­–ç•¥ï¼Œè«‹é»æ“Šæ·±åº¦å ±å‘ŠæŸ¥çœ‹ã€‚`;
      
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
      const payload = {
        contents: [{ parts: [{ text: briefing }] }],
        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } },
        model: "gemini-2.5-flash-preview-tts"
      };

      try {
        const resp = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        const res = await resp.json();
        const pcm = res.candidates[0].content.parts[0].inlineData.data;
        const wavUrl = pcmToWav(pcm, 24000);
        new Audio(wavUrl).play();
      } catch (e) {
        console.error("TTS Error", e);
      } finally {
        btn.innerHTML = originalText;
      }
    }

    function pcmToWav(b64, sr) {
      const bin = atob(b64), len = bin.length, buf = new Uint8Array(len);
      for(let i=0; i<len; i++) buf[i] = bin.charCodeAt(i);
      const header = new ArrayBuffer(44), view = new DataView(header);
      view.setUint32(0, 0x52494646, false); view.setUint32(4, 36+len, true);
      view.setUint32(8, 0x57415645, false); view.setUint32(12, 0x666d7420, false);
      view.setUint32(16, 16, true); view.setUint16(20, 1, true);
      view.setUint16(22, 1, true); view.setUint32(24, sr, true);
      view.setUint32(28, sr*2, true); view.setUint16(32, 2, true);
      view.setUint16(34, 16, true); view.setUint32(36, 0x64617461, false); view.setUint32(40, len, true);
      return URL.createObjectURL(new Blob([header, buf], {type: 'audio/wav'}));
    }

    function copyAIData() {
        const text = aiOutputContent.innerText;
        navigator.clipboard.writeText(text);
        alert('å ±å‘Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    }

    function closeAIOutput() { aiOutputBox.classList.add('hidden'); }
  </script>
</body>
</html>