<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yahoo 版位成效決策儀表板 v3 (AI Pro)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: #0f172a;
      color: #f8fafc;
    }
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #1e293b;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 10px;
    }
    .grade-a { background-color: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
    .grade-b { background-color: rgba(234, 179, 8, 0.15); color: #facc15; border: 1px solid rgba(234, 179, 8, 0.3); }
    .grade-c { background-color: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
    .grade-d { background-color: rgba(148, 163, 184, 0.1); color: #94a3b8; border: 1px solid rgba(148, 163, 184, 0.2); }
    
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      opacity: 1;
    }

    .ai-loading {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
  </style>
</head>
<body class="flex h-screen overflow-hidden">

  <!-- Sidebar: Configuration & Manual Input -->
  <aside class="w-80 bg-slate-900 border-r border-slate-800 p-6 flex flex-col gap-8 shrink-0 overflow-y-auto custom-scrollbar">
    <div>
      <h2 class="text-sky-400 text-xl font-bold mb-2">決策參數設定</h2>
      <p class="text-slate-500 text-xs">手動調整基準值即時更新分級</p>
    </div>

    <div class="space-y-6">
      <!-- Benchmark A -->
      <div class="space-y-2">
        <label class="block text-sm font-medium text-slate-400">A 級門檻 (CTR %)</label>
        <div class="relative">
          <input type="number" id="threshold-a" value="0.5" step="0.1" 
                 class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-sky-500 outline-none transition-all">
          <span class="absolute right-3 top-2.5 text-slate-600">%</span>
        </div>
        <p class="text-[10px] text-slate-500">當前標準：CTR ≧ <span class="val-a">0.5</span>%</p>
      </div>

      <!-- Benchmark B -->
      <div class="space-y-2">
        <label class="block text-sm font-medium text-slate-400">B 級門檻 (CTR %)</label>
        <div class="relative">
          <input type="number" id="threshold-b" value="0.1" step="0.1" 
                 class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-yellow-500 outline-none transition-all">
          <span class="absolute right-3 top-2.5 text-slate-600">%</span>
        </div>
      </div>

      <!-- Benchmark C (Imps) -->
      <div class="space-y-2">
        <label class="block text-sm font-medium text-slate-400">C 級曝光基準 (Imps >)</label>
        <input type="number" id="threshold-imps" value="1000" 
               class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-red-500 outline-none transition-all">
      </div>
    </div>

    <div class="mt-4 space-y-4">
      <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">AI 工具箱</h3>
      <button onclick="generateAIDeepAnalysis()" class="w-full flex items-center justify-center gap-2 bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 border border-purple-500/30 font-bold py-3 px-4 rounded-xl cursor-pointer transition-all">
        ✨ 產生 AI 深度洞察
      </button>
      <button onclick="generateProfessionalEmail()" class="w-full flex items-center justify-center gap-2 bg-emerald-600/20 hover:bg-emerald-600/30 text-emerald-400 border border-emerald-500/30 font-bold py-3 px-4 rounded-xl cursor-pointer transition-all">
        ✨ 產生專業媒體信函
      </button>
      <button onclick="generateVoiceBriefing()" id="btn-voice" class="w-full flex items-center justify-center gap-2 bg-amber-600/20 hover:bg-amber-600/30 text-amber-400 border border-amber-500/30 font-bold py-3 px-4 rounded-xl cursor-pointer transition-all">
        ✨ 語音導讀摘要
      </button>
    </div>

    <div class="mt-auto space-y-4 pt-8">
      <label for="file-upload" class="flex items-center justify-center gap-2 bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-4 rounded-xl cursor-pointer transition-colors shadow-lg shadow-sky-900/20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
        上傳 Yahoo CSV
      </label>
      <input type="file" id="file-upload" class="hidden" accept=".csv">
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col overflow-hidden bg-slate-950">
    <!-- Header -->
    <header class="h-16 border-b border-slate-800 flex items-center justify-between px-10 shrink-0">
      <div class="flex items-center gap-3">
        <div class="h-3 w-3 bg-sky-500 rounded-full animate-pulse"></div>
        <h1 class="text-lg font-bold tracking-tight">版位成效實時分析系統 <span class="text-slate-500 font-normal ml-2">v3.1 (AI Enabled)</span></h1>
      </div>
      <div class="text-sm text-slate-400" id="file-name-display">尚未選擇檔案</div>
    </header>

    <!-- Data Content -->
    <div class="flex-1 overflow-y-auto px-10 pb-10 custom-scrollbar">
      <div id="welcome-screen" class="flex flex-col items-center justify-center h-64 text-slate-600 border-2 border-dashed border-slate-800 rounded-3xl mt-10">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
        <p>請從左側上傳 CSV 檔案或手動調整參數</p>
      </div>

      <div id="analysis-content" class="hidden space-y-8 mt-8">
        <!-- Summary Cards -->
        <div class="grid grid-cols-4 gap-6">
          <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800">
            <p class="text-xs text-slate-500 mb-1">總曝光量 (Imps)</p>
            <h3 id="stat-imps" class="text-2xl font-bold text-white">-</h3>
          </div>
          <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800">
            <p class="text-xs text-slate-500 mb-1">總點擊數 (Clicks)</p>
            <h3 id="stat-clicks" class="text-2xl font-bold text-white">-</h3>
          </div>
          <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800">
            <p class="text-xs text-slate-500 mb-1">平均點擊率 (CTR)</p>
            <h3 id="stat-ctr" class="text-2xl font-bold text-sky-400">-%</h3>
          </div>
          <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800">
            <p class="text-xs text-slate-500 mb-1">高價值(A)版位佔比</p>
            <h3 id="stat-grade-a" class="text-2xl font-bold text-green-400">-</h3>
          </div>
        </div>

        <!-- AI Output Box (Hidden until used) -->
        <div id="ai-output-box" class="hidden bg-slate-900/80 border border-purple-500/30 rounded-3xl p-6 relative">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 bg-purple-500 rounded-full animate-ping"></span>
              <h4 id="ai-output-title" class="text-purple-400 font-bold">AI 深度洞察報告</h4>
            </div>
            <button onclick="closeAIOutput()" class="text-slate-500 hover:text-white">✕</button>
          </div>
          <div id="ai-output-content" class="text-slate-300 text-sm leading-relaxed prose prose-invert max-w-none">
            <!-- AI Content -->
          </div>
        </div>

        <!-- Table -->
        <div class="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden">
          <table class="w-full text-left">
            <thead>
              <tr class="bg-slate-800/50 text-[11px] uppercase tracking-wider text-slate-500">
                <th class="px-6 py-4">分級</th>
                <th class="px-6 py-4">版位名稱 (Line Item)</th>
                <th class="px-6 py-4">曝光</th>
                <th class="px-6 py-4">點擊</th>
                <th class="px-6 py-4 text-right">CTR (%)</th>
              </tr>
            </thead>
            <tbody id="data-tbody" class="divide-y divide-slate-800 text-sm text-slate-300"></tbody>
          </table>
        </div>

        <!-- AI Insight & Copy Action -->
        <div class="bg-gradient-to-br from-slate-900 to-slate-950 border border-sky-500/20 rounded-3xl p-8 relative overflow-hidden group">
          <div class="relative">
            <div class="flex items-center gap-2 mb-4">
              <span class="px-2 py-0.5 bg-sky-500/10 text-sky-400 text-[10px] font-bold rounded uppercase tracking-tighter">AI 決策助理</span>
              <h4 class="text-lg font-bold text-white">即時操作建議</h4>
            </div>
            <p id="insight-text" class="text-slate-400 text-sm mb-6 leading-relaxed max-w-3xl">尚無數據。</p>
            <div class="flex flex-col gap-3">
              <label class="text-[10px] text-slate-500 font-bold uppercase">媒體操作一句話指示</label>
              <textarea id="media-command" readonly class="w-full bg-black/50 border border-slate-700 rounded-xl p-4 text-sm font-mono text-emerald-400 h-24 resize-none focus:outline-none"></textarea>
              <button onclick="copyCommand()" class="self-start flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold py-2.5 px-6 rounded-lg transition-all active:scale-95">
                複製指令
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const apiKey = ""; // 執行環境會自動提供
    let currentData = [];
    let summaryData = { aList: [], bList: [], cList: [], dList: [], totalImps: 0, totalClicks: 0 };

    // UI Elements
    const fileUpload = document.getElementById('file-upload');
    const fileNameDisplay = document.getElementById('file-name-display');
    const welcomeScreen = document.getElementById('welcome-screen');
    const analysisContent = document.getElementById('analysis-content');
    const tbody = document.getElementById('data-tbody');
    const mediaCommand = document.getElementById('media-command');
    const insightText = document.getElementById('insight-text');
    const aiOutputBox = document.getElementById('ai-output-box');
    const aiOutputContent = document.getElementById('ai-output-content');
    const aiOutputTitle = document.getElementById('ai-output-title');

    // Thresholds
    const inputA = document.getElementById('threshold-a');
    const inputB = document.getElementById('threshold-b');
    const inputImps = document.getElementById('threshold-imps');

    // Event Listeners
    fileUpload.addEventListener('change', handleFileUpload);
    [inputA, inputB, inputImps].forEach(el => {
      el.addEventListener('input', () => {
        document.querySelector('.val-a').textContent = inputA.value;
        if (currentData.length > 0) renderAnalysis(currentData);
      });
    });

    async function callGemini(prompt, systemInstruction = "你是一位資深數位廣告分析師。") {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
      
      const makeRequest = async () => {
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: systemInstruction }] }
          })
        });
        if (!response.ok) throw new Error("API Request Failed");
        return await response.json();
      };

      // Exponential backoff
      for (let i = 0; i < 5; i++) {
        try {
          const result = await makeRequest();
          return result.candidates?.[0]?.content?.parts?.[0]?.text;
        } catch (e) {
          if (i === 4) throw e;
          await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
        }
      }
    }

    async function callGeminiTTS(text) {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `Say professionally and clearly: ${text}` }] }],
          generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
          },
          model: "gemini-2.5-flash-preview-tts"
        })
      });
      const result = await response.json();
      const pcmData = result.candidates[0].content.parts[0].inlineData.data;
      return pcmToWav(pcmData, 24000); // 假設取樣率 24k
    }

    function pcmToWav(base64Pcm, sampleRate) {
      const binaryString = window.atob(base64Pcm);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
      
      const wavHeader = new ArrayBuffer(44);
      const view = new DataView(wavHeader);
      view.setUint32(0, 0x52494646, false); // "RIFF"
      view.setUint32(4, 36 + len, true);
      view.setUint32(8, 0x57415645, false); // "WAVE"
      view.setUint32(12, 0x666d7420, false); // "fmt "
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true); // PCM
      view.setUint16(22, 1, true); // Mono
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, sampleRate * 2, true);
      view.setUint16(32, 2, true);
      view.setUint16(34, 16, true);
      view.setUint32(36, 0x64617461, false); // "data"
      view.setUint32(40, len, true);

      const blob = new Blob([wavHeader, bytes], { type: 'audio/wav' });
      return URL.createObjectURL(blob);
    }

    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      fileNameDisplay.textContent = file.name;
      const reader = new FileReader();
      reader.onload = (event) => {
        currentData = parseYahooCSV(event.target.result);
        welcomeScreen.classList.add('hidden');
        analysisContent.classList.remove('hidden');
        renderAnalysis(currentData);
      };
      reader.readAsText(file);
    }

    function parseYahooCSV(csv) {
      const lines = csv.split(/\r?\n/).filter(line => line.trim() !== "");
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const idxItem = headers.indexOf('Line item');
      const idxImp = headers.indexOf('Total impressions');
      const idxClick = headers.indexOf('Total clicks');
      const map = new Map();
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
        if (cols.length < headers.length) continue;
        const name = cols[idxItem], imps = parseInt(cols[idxImp]) || 0, clicks = parseInt(cols[idxClick]) || 0;
        if (map.has(name)) {
          map.get(name).imps += imps; map.get(name).clicks += clicks;
        } else map.set(name, { name, imps, clicks });
      }
      return Array.from(map.values());
    }

    function renderAnalysis(data) {
      const tA = parseFloat(inputA.value) / 100, tB = parseFloat(inputB.value) / 100, tImps = parseInt(inputImps.value);
      tbody.innerHTML = "";
      summaryData = { aList: [], bList: [], cList: [], dList: [], totalImps: 0, totalClicks: 0 };
      const sorted = [...data].sort((a, b) => (b.clicks/b.imps) - (a.clicks/a.imps));

      sorted.forEach(item => {
        const ctr = item.imps > 0 ? (item.clicks / item.imps) : 0;
        let grade = "D", gradeText = "噪音", gradeClass = "grade-d";
        if (ctr >= tA) { grade = "A"; gradeText = "高價值"; gradeClass = "grade-a"; summaryData.aList.push(item); }
        else if (ctr >= tB) { grade = "B"; gradeText = "潛力"; gradeClass = "grade-b"; summaryData.bList.push(item); }
        else if (item.imps >= tImps) { grade = "C"; gradeText = "低效"; gradeClass = "grade-c"; summaryData.cList.push(item); }
        else summaryData.dList.push(item);
        
        summaryData.totalImps += item.imps; summaryData.totalClicks += item.clicks;
        const row = document.createElement('tr');
        row.innerHTML = `<td class="px-6 py-4"><span class="grade-badge px-2 py-1 rounded text-[10px] font-bold ${gradeClass}">${grade} 級｜${gradeText}</span></td><td class="px-6 py-4 font-medium text-slate-100">${item.name}</td><td class="px-6 py-4">${item.imps.toLocaleString()}</td><td class="px-6 py-4">${item.clicks.toLocaleString()}</td><td class="px-6 py-4 text-right font-mono text-sky-400">${(ctr * 100).toFixed(3)}%</td>`;
        tbody.appendChild(row);
      });

      document.getElementById('stat-imps').textContent = summaryData.totalImps.toLocaleString();
      document.getElementById('stat-clicks').textContent = summaryData.totalClicks.toLocaleString();
      document.getElementById('stat-ctr').textContent = (summaryData.totalClicks / summaryData.totalImps * 100).toFixed(3) + "%";
      document.getElementById('stat-grade-a').textContent = summaryData.aList.length + " 個";
      insightText.innerHTML = `系統辨識出 <b>${summaryData.aList.length}</b> 個高轉化版位及 <b>${summaryData.cList.length}</b> 個低效版位。建議優先加碼 A 級版位。`;
      mediaCommand.value = `Yahoo 操作指令：優先加碼【${summaryData.aList.map(i=>i.name).join('、') || '無'}】；排除【${summaryData.cList.map(i=>i.name).join('、') || '無'}】。`;
    }

    async function generateAIDeepAnalysis() {
      if (currentData.length === 0) return alert("請先上傳資料");
      showAILoading("AI 深度洞察報告");
      const prompt = `請根據以下 Yahoo 廣告版位數據進行深度分析：
      總曝光：${summaryData.totalImps}，總點擊：${summaryData.totalClicks}，平均 CTR：${(summaryData.totalClicks/summaryData.totalImps*100).toFixed(3)}%
      A級版位：${summaryData.aList.map(i => `${i.name}(CTR:${(i.clicks/i.imps*100).toFixed(2)}%)`).join(', ')}
      C級版位：${summaryData.cList.map(i => `${i.name}(曝光:${i.imps}, CTR:${(i.clicks/i.imps*100).toFixed(2)}%)`).join(', ')}
      請分析版位命名中呈現的趨勢（例如裝置、內容分類、廣告格式），並給予 3 點具體洞察。`;
      
      try {
        const response = await callGemini(prompt);
        aiOutputContent.innerHTML = response.replace(/\n/g, '<br>');
      } catch (e) {
        aiOutputContent.innerText = "生成失敗，請稍後再試。";
      } finally {
        stopAILoading();
      }
    }

    async function generateProfessionalEmail() {
      if (currentData.length === 0) return alert("請先上傳資料");
      showAILoading("專業媒體信函建議");
      const prompt = `請根據分析結果，撰寫一封發給媒體代理商優化專員的專業 Email。要求：
      1. 語氣專業、客氣但果斷。
      2. 條列式列出要加碼的版位：${summaryData.aList.map(i=>i.name).join('、')}。
      3. 條列式列出要停止投放的低效版位：${summaryData.cList.map(i=>i.name).join('、')}。
      4. 詢問對方是否有其他高潛力版位建議。`;

      try {
        const response = await callGemini(prompt, "你是一位專業的數位行銷經理。");
        aiOutputContent.innerHTML = response.replace(/\n/g, '<br>');
      } catch (e) {
        aiOutputContent.innerText = "生成失敗。";
      } finally {
        stopAILoading();
      }
    }

    async function generateVoiceBriefing() {
      if (currentData.length === 0) return alert("請先上傳資料");
      const btn = document.getElementById('btn-voice');
      btn.classList.add('ai-loading');
      btn.innerText = "✨ 正在生成語音...";
      
      const summaryText = `本次廣告投放總共獲得 ${summaryData.totalImps} 次曝光，平均點擊率為 ${(summaryData.totalClicks/summaryData.totalImps*100).toFixed(2)}%。我們辨識出 ${summaryData.aList.length} 個表現優異的 A 級版位，建議優先加碼。同時有 ${summaryData.cList.length} 個低效版位應立即停止投放以節省預算。`;
      
      try {
        const audioUrl = await callGeminiTTS(summaryText);
        const audio = new Audio(audioUrl);
        audio.play();
      } catch (e) {
        alert("語音生成失敗");
      } finally {
        btn.classList.remove('ai-loading');
        btn.innerText = "✨ 語音導讀摘要";
      }
    }

    function showAILoading(title) {
      aiOutputBox.classList.remove('hidden');
      aiOutputTitle.innerText = title;
      aiOutputContent.innerHTML = `<div class="ai-loading text-purple-400">正在呼叫 Gemini AI 進行深度計算與分析...</div>`;
    }

    function stopAILoading() {
      // No change needed here
    }

    function closeAIOutput() { aiOutputBox.classList.add('hidden'); }
    function copyCommand() { mediaCommand.select(); document.execCommand('copy'); alert('指令已複製'); }
  </script>
</body>
</html>